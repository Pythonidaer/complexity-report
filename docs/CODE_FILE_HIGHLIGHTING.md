# Code File Representation & Highlighting System

## Overview

The individual code file representation (with red and yellow highlighting) is generated by the **File Page HTML Generator** system in `scripts/html-generators/`.

## What Generates What

### ðŸŽ¨ **Red Highlighting** = Decision Points
- **Color:** `#F6C6CE` (pink/red)
- **CSS Class:** `.decision-point-line`
- **What it highlights:** Lines containing decision points (if, for, ternary, &&, ||, etc.)

### ðŸŽ¨ **Yellow Highlighting** = Function Boundaries
- **Color:** `yellow`
- **CSS Class:** `.function-boundary-highlight`
- **What it highlights:** Function start lines and closing lines

## The Complete Flow

### 1. **Entry Point: `generateFileHTML()`**
**File:** `scripts/html-generators/file.js`

This is the main orchestrator that generates the complete HTML page for each source file.

```javascript
export async function generateFileHTML(
  filePath,
  functions,
  projectRoot,
  findFunctionBoundaries,
  parseDecisionPoints,
  calculateComplexityBreakdown,
  formatFunctionHierarchy,
  // ... other params
)
```

**Steps:**
1. Reads the source file
2. Creates data maps
3. Generates Function Complexity Breakdown table
4. Generates line-by-line HTML with highlighting
5. Returns complete HTML document

### 2. **Data Preparation**

#### A. **Line-to-Function Map**
**File:** `scripts/html-generators/file-data.js`

```javascript
const lineToFunction = createLineToFunctionMap(functions);
```

Creates a `Map<lineNumber, functionObject>` so we know which function starts on each line.

#### B. **Function Boundaries**
**File:** `scripts/function-boundaries/index.js`

```javascript
const functionBoundaries = findFunctionBoundaries(sourceCode, functions);
```

Returns `Map<functionLine, { start, end }>` - the start and end line for each function.

#### C. **Decision Points**
**File:** `scripts/decision-points/index.js`

```javascript
const decisionPoints = await parseDecisionPoints(
  sourceCode,
  functionBoundaries,
  functions,
  filePath,
  projectRoot
);
```

Returns array of decision point objects:
```javascript
{
  type: 'if',              // Decision point type
  line: 46,                // Line number
  column: 5,               // Start column (0-based)
  endColumn: 50,           // End column (0-based)
  functionLine: 28,        // Which function it belongs to
  name: 'if statement'     // Description
}
```

#### D. **Line-to-Decision-Point Map**
**File:** `scripts/html-generators/file-data.js`

```javascript
const lineToDecisionPoint = createDecisionPointLineMap(decisionPoints);
```

Creates `Map<lineNumber, [decisionPoints]>` - array of all decision points on each line.

#### E. **Boundary Line Sets**
**File:** `scripts/html-generators/file-boundary-builders.js`

```javascript
const { functionStartLines, functionEndLines, functionClosingLines } =
  buildBoundaryLineSets(functionBoundaries, sourceLines.length, functions);
```

Creates three `Set` objects:
- `functionStartLines` - Lines where functions start
- `functionEndLines` - Lines where functions end
- `functionClosingLines` - Lines with closing braces

### 3. **Line Rendering**

#### **For Each Line:** `generateLineRowHTML()`
**File:** `scripts/html-generators/file-line-render.js`

```javascript
const lineRows = sourceLines.map((line, index) =>
  generateLineRowHTML(
    line,
    index,
    lineToFunction,
    lineToDecisionPoint,
    functionStartLines,
    functionEndLines,
    functionClosingLines,
    getComplexityLevel,
    escapeHtml,
    languageClass
  )
).join('\n');
```

**What `generateLineRowHTML()` does:**

1. **Gets line metadata:**
   - Is there a function starting on this line?
   - Are there decision points on this line?
   - Is this a function boundary line?

2. **Determines highlighting classes:**
   ```javascript
   const { classAttr, isDecisionPoint, isFunctionStart, isFunctionClosing } =
     determineLineClasses(decisionPointsOnLine, lineNum, functionStartLines, functionEndLines, functionClosingLines);
   ```

3. **Builds the code line HTML with highlighting:**
   ```javascript
   const codeLineHTML = buildCodeLineHTML(
     line,
     escapeHtml,
     isDecisionPoint,
     isFunctionStart,
     isFunctionClosing,
     decisionPointsOnLine,
     functionStartColumn
   );
   ```

4. **Returns HTML row:**
   ```html
   <tr data-line="46">
     <td class="line-count"><a href='#L46'>46</a></td>
     <td class="line-coverage">2</td> <!-- complexity annotation -->
     <td class="text"><pre class="prettyprint lang-js">
       <!-- highlighted code here -->
     </pre></td>
   </tr>
   ```

### 4. **Code Line Highlighting Logic**

#### **Function:** `buildCodeLineHTML()`
**File:** `scripts/html-generators/file-line-render.js`

This is where the red and yellow highlighting is applied!

**Four Highlighting Modes:**

1. **PLAIN** - No highlighting
   ```html
   <span class="code-line">  const x = 5;</span>
   ```

2. **FULL_LINE** - Entire line highlighted (red OR yellow)
   ```html
   <span class="code-line decision-point-line">  if (x > 0) {</span>
   ```

3. **FUNCTION_START** - Partial line highlighting (yellow from function start)
   ```html
   <span class="code-line">  functions.</span>
   <span class="code-line function-boundary-highlight">forEach((func) => {</span>
   ```

4. **GRANULAR** - Mixed highlighting (red + yellow segments)
   ```html
   <span class="code-line function-boundary-highlight">async function calc(</span>
   <span class="code-line decision-point-line">x = 10</span>
   <span class="code-line function-boundary-highlight">) {</span>
   ```

**Mode Selection Logic:**

```javascript
function getCodeLineHighlightMode(
  isDecisionPoint,
  isFunctionStart,
  isFunctionClosing,
  hasDPColumnInfo,
  dpRangesLength,
  validStartColumn
) {
  // GRANULAR: When line has BOTH decision points AND function boundaries
  // AND we have column information for precise highlighting
  if (canUseGranularCodeLineHighlight(...)) return CODE_LINE_MODE.GRANULAR;
  
  // PLAIN: No highlighting needed
  if (!isDecisionPoint && !isFunctionStart && !isFunctionClosing) {
    return CODE_LINE_MODE.PLAIN;
  }
  
  // FUNCTION_START: Start yellow highlight at function start column
  if (isFunctionStart && validStartColumn) {
    return CODE_LINE_MODE.FUNCTION_START;
  }
  
  // FULL_LINE: Highlight entire line
  return CODE_LINE_MODE.FULL_LINE;
}
```

**Granular Mode Details:**

When a line has BOTH decision points AND function boundaries (e.g., default parameter on function declaration):

```javascript
async function calculateDecisionPointTotals(allFunctions, projectRoot, findFunctionBoundaries, parseDecisionPoints = defaultParser) {
```

1. **Get decision point ranges:**
   ```javascript
   const dpRanges = getDecisionPointRanges(decisionPointsOnLine, lineLength);
   // Returns: [{ start: 122, end: 135 }] for "defaultParser"
   ```

2. **Build segments:**
   ```javascript
   const segments = buildSegmentsFromDPRanges(dpRanges, lineLength);
   // Returns:
   // [
   //   { start: 0, end: 122, isDP: false },    // Yellow (function start)
   //   { start: 122, end: 135, isDP: true },   // Red (default param)
   //   { start: 135, end: 150, isDP: false }   // Yellow (rest of line)
   // ]
   ```

3. **Render each segment:**
   ```javascript
   segments.map(seg => {
     const cls = seg.isDP
       ? 'code-line decision-point-line'          // RED
       : 'code-line function-boundary-highlight'; // YELLOW
     return `<span class="${cls}">${escapeHtml(raw)}</span>`;
   });
   ```

### 5. **CSS Styling**

**File:** `scripts/html-generators/file.css`

```css
/* Red highlighting for decision points */
.decision-point-line {
  background: #F6C6CE; /* Pink/red */
}

/* Yellow highlighting for function boundaries */
.function-boundary-highlight {
  background: yellow !important;
}

/* When "Show Highlights & Borders" is unchecked */
.coverage-table-wrapper.hide-highlights .decision-point-line {
  background: transparent;
}

.coverage-table-wrapper.hide-highlights .function-boundary-highlight {
  background: transparent !important;
}
```

## Example: Line 46 in Your Image

```javascript
controlFlowTypes.forEach((type) => { controlFlowTotal += breakdown.breakdown[type] || 0; });
```

**Highlighting Process:**

1. **Data lookup:**
   - `lineToDecisionPoint.get(46)` â†’ `[{ type: 'forEach', line: 46, column: 5, endColumn: 95 }]`
   - `functionStartLines.has(46)` â†’ `true` (forEach callback starts here)
   - `lineToFunction.get(46)` â†’ `{ line: 46, functionName: 'forEach', column: 20 }`

2. **Mode selection:**
   - `isDecisionPoint` = `true` (has decision points)
   - `isFunctionStart` = `true` (function starts here)
   - `hasDPColumnInfo` = `true` (has column data)
   - **Mode:** `GRANULAR` (mixed red + yellow)

3. **Segment building:**
   - Parse decision point ranges from column data
   - Split line into segments: yellow (function start) â†’ red (decision points) â†’ yellow (rest)

4. **HTML output:**
   ```html
   <span class="code-line function-boundary-highlight">  controlFlowTypes.</span>
   <span class="code-line decision-point-line">forEach((type) => { controlFlowTotal += breakdown.breakdown[type] || 0; });</span>
   ```

## Key Files Summary

| File | Purpose |
|------|---------|
| **`file.js`** | Main orchestrator - generates complete file HTML |
| **`file-line-render.js`** | Line rendering logic - applies red/yellow highlighting |
| **`file-data.js`** | Creates line-to-function and line-to-decision-point maps |
| **`file-boundary-builders.js`** | Builds boundary line sets (start/end/closing) |
| **`file-css.js`** | CSS styles for highlighting |
| **`file-javascript.js`** | JavaScript for interactivity (show/hide highlights) |

## Data Flow Diagram

```
ESLint Results
    â†“
functions array â†’ createLineToFunctionMap() â†’ lineToFunction Map
    â†“
findFunctionBoundaries() â†’ functionBoundaries Map
    â†“
parseDecisionPoints() â†’ decisionPoints array
    â†“
createDecisionPointLineMap() â†’ lineToDecisionPoint Map
    â†“
buildBoundaryLineSets() â†’ functionStartLines, functionEndLines, functionClosingLines Sets
    â†“
For each line:
  generateLineRowHTML()
    â†“
  determineLineClasses() â†’ isDecisionPoint, isFunctionStart, isFunctionClosing
    â†“
  buildCodeLineHTML() â†’ Highlighted HTML
    â†“
  Apply CSS classes:
    - .decision-point-line â†’ RED
    - .function-boundary-highlight â†’ YELLOW
```

## Toggle Functionality

The "Show Highlights & Borders" checkbox controls visibility:

```javascript
// When unchecked, adds 'hide-highlights' class to wrapper
<div class="coverage-table-wrapper hide-highlights">
```

CSS then hides the backgrounds:

```css
.coverage-table-wrapper.hide-highlights .decision-point-line {
  background: transparent;
}
```

## Performance Considerations

- **Line-by-line generation:** Each line is processed independently
- **Map lookups:** O(1) lookups for line metadata
- **Column-based highlighting:** Only applied when column data is available
- **Syntax highlighting:** Uses Google Code Prettify library for language-aware syntax coloring

## Testing

Tests are in `scripts/__tests__/html-generators.test.js` and cover:
- Line row generation
- Highlighting logic
- Code line HTML building
- Edge cases (empty lines, long lines, etc.)
